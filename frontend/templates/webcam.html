<!DOCTYPE html>
<html>
<head>
    <title>Webcam Stream - XSRT Test Bench</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Webcam Stream</h1>
            <div class="header-controls">
                <a href="/" class="header-btn">‚Üê Back to Control Panel</a>
                <button id="toggle-stream" class="header-btn">‚ñ∂Ô∏è Start Stream</button>
                <button id="refresh-stream" class="header-btn secondary">üîÑ Refresh</button>
            </div>
        </header>

        <div class="webcam-container">
            <div id="stream-status" class="status-message">
                <p>üîå Connecting to stream server...</p>
            </div>
            <img id="video-stream" src="" width="100%" alt="Webcam Stream" style="display: none;">
        </div>

        <div class="webcam-info">
            <h3>Stream Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Status:</strong> <span id="status-text">Disconnected</span>
                </div>
                <div class="info-item">
                    <strong>Resolution:</strong> <span id="resolution-text">640x480</span>
                </div>
                <div class="info-item">
                    <strong>Frame Rate:</strong> <span id="fps-text">~30 FPS</span>
                </div>
                <div class="info-item">
                    <strong>Connection:</strong> <span id="connection-text">WebSocket</span>
                </div>
            </div>

            <h3>Stream Settings</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="resolution-select">Resolution:</label>
                    <select id="resolution-select" class="setting-select">
                        <option value="320x240">320x240 (Low)</option>
                        <option value="640x480" selected>640x480 (Medium)</option>
                        <option value="800x600">800x600 (High)</option>
                        <option value="1280x720">1280x720 (HD)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="latency-select">Latency:</label>
                    <select id="latency-select" class="setting-select">
                        <option value="0.016">60 FPS (16ms)</option>
                        <option value="0.033" selected>30 FPS (33ms)</option>
                        <option value="0.066">15 FPS (66ms)</option>
                        <option value="0.1">10 FPS (100ms)</option>
                        <option value="0.2">5 FPS (200ms)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="quality-slider">Quality: <span id="quality-value">80</span>%</label>
                    <input type="range" id="quality-slider" class="setting-slider" min="0" max="100" value="80" step="5">
                </div>
                <div class="setting-item">
                    <button id="apply-settings" class="setting-btn">Apply Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const videoStream = document.getElementById('video-stream');
        const streamStatus = document.getElementById('stream-status');
        const statusText = document.getElementById('status-text');
        const toggleBtn = document.getElementById('toggle-stream');
        const refreshBtn = document.getElementById('refresh-stream');

        let socket;
        let isStreaming = false;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let currentSettings = {
            resolution: '640x480',
            latency: 0.033,
            quality: 80
        };

        function initSocket() {
            socket = io('/webcam');

            socket.on('connect', function() {
                console.log('Connected to WebSocket');
                statusText.textContent = 'Connected';
                streamStatus.innerHTML = '<p>‚úÖ Connected! Click "Start Stream" to begin.</p>';
                // Send current settings to server
                socket.emit('update_settings', currentSettings);
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from WebSocket');
                statusText.textContent = 'Disconnected';
                streamStatus.innerHTML = '<p>üîå Connection lost. Attempting to reconnect...</p>';
                videoStream.style.display = 'none';
                toggleBtn.innerHTML = '‚ñ∂Ô∏è Start Stream';
                toggleBtn.disabled = true;
                isStreaming = false;
                setTimeout(initSocket, 2000);
            });

            socket.on('status', function(data) {
                console.log('Status:', data.message);
                if (data.message === 'Stream started') {
                    streamStatus.style.display = 'none';
                    videoStream.style.display = 'block';
                } else if (data.message === 'Stream stopped') {
                    streamStatus.innerHTML = '<p>‚è∏Ô∏è Stream paused. Click "Start Stream" to resume.</p>';
                    streamStatus.style.display = 'block';
                    videoStream.style.display = 'none';
                }
            });

            socket.on('video_frame', function(data) {
                // Update the image source with the new frame
                videoStream.src = 'data:image/jpeg;base64,' + data.frame;
                frameCount++;

                // Update FPS every second
                const now = Date.now();
                if (now - lastFpsUpdate > 1000) {
                    const fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
                    document.getElementById('fps-text').textContent = fps + ' FPS';
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
            });

            socket.on('error', function(data) {
                console.error('Stream error:', data.message);
                streamStatus.innerHTML = '<p>‚ùå Error: ' + data.message + '</p>';
                streamStatus.style.display = 'block';
                videoStream.style.display = 'none';
                toggleBtn.innerHTML = '‚ñ∂Ô∏è Start Stream';
                isStreaming = false;
            });

            socket.on('settings_updated', function(data) {
                console.log('Settings updated:', data);
                document.getElementById('resolution-text').textContent = currentSettings.resolution;
                const fps = Math.round(1000 / (currentSettings.latency * 1000));
                document.getElementById('fps-text').textContent = '~' + fps + ' FPS';
                // Update quality display
                qualityValue.textContent = currentSettings.quality;
                qualitySlider.value = currentSettings.quality;
            });
        }

        toggleBtn.addEventListener('click', function() {
            if (!socket || !socket.connected) {
                alert('Not connected to server. Please wait for connection.');
                return;
            }

            if (isStreaming) {
                socket.emit('stop_stream');
                toggleBtn.innerHTML = '‚ñ∂Ô∏è Start Stream';
                isStreaming = false;
            } else {
                socket.emit('start_stream');
                toggleBtn.innerHTML = '‚è∏Ô∏è Stop Stream';
                isStreaming = true;
            }
        });

        refreshBtn.addEventListener('click', function() {
            if (socket && socket.connected) {
                socket.disconnect();
                setTimeout(initSocket, 500);
            }
        });

        // Settings controls
        const resolutionSelect = document.getElementById('resolution-select');
        const latencySelect = document.getElementById('latency-select');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const applyBtn = document.getElementById('apply-settings');

        // Update quality value display when slider changes
        qualitySlider.addEventListener('input', function() {
            qualityValue.textContent = this.value;
        });

        function updateSettings() {
            currentSettings.resolution = resolutionSelect.value;
            currentSettings.latency = parseFloat(latencySelect.value);
            currentSettings.quality = parseInt(qualitySlider.value);

            if (socket && socket.connected) {
                socket.emit('update_settings', currentSettings);
                applyBtn.textContent = 'Applying...';
                applyBtn.disabled = true;

                // Re-enable button after a short delay
                setTimeout(() => {
                    applyBtn.textContent = 'Apply Settings';
                    applyBtn.disabled = false;
                }, 1000);
            } else {
                alert('Not connected to server. Settings will be applied when connected.');
            }
        }

        applyBtn.addEventListener('click', updateSettings);

        // Auto-apply settings when streaming starts
        function applyCurrentSettings() {
            if (socket && socket.connected) {
                socket.emit('update_settings', currentSettings);
            }
        }

        // Initialize socket connection when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            // Initialize quality value display
            qualityValue.textContent = qualitySlider.value;
            setTimeout(() => {
                toggleBtn.disabled = false;
            }, 1000);
        });
    </script>
</body>
</html>